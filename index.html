<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Audiobookshelf Library Tidy Tool</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Organize your Audiobookshelf library with ease">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tidy Library">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .changes-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f9fafb;
        }

        .book-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .book-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .change-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        .old-path {
            color: #dc2626;
            text-decoration: line-through;
        }

        .new-path {
            color: #10b981;
            font-weight: 500;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .collision-list {
            background: #fee2e2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .collision-list h4 {
            color: #991b1b;
            margin-bottom: 10px;
        }

        .collision-list ul {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .collision-list li {
            padding: 5px 0;
            color: #7f1d1d;
            font-size: 0.9em;
        }

        .path-validation {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .path-validation.valid {
            background: #d1fae5;
            color: #065f46;
        }

        .path-validation.invalid {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Audiobookshelf Library Tidy</h1>
            <p>Organize your audiobook library with ease</p>
        </div>

        <div class="content">
            <!-- Step 1: Library Path -->
            <div class="section active" id="step1">
                <h2>Step 1: Select Library</h2>
                <div class="form-group">
                    <label for="libraryPath">Library Path</label>
                    <input type="text" id="libraryPath" placeholder="/path/to/your/audiobooks" />
                    <div id="pathValidation" class="path-validation" style="display:none;"></div>
                </div>
                <div class="form-group">
                    <label for="configPath">Config File (Optional)</label>
                    <input type="text" id="configPath" placeholder="/path/to/config.yaml" />
                </div>
                <button class="btn btn-primary" id="scanBtn">Scan Library</button>
            </div>

            <!-- Step 2: Review Changes -->
            <div class="section" id="step2">
                <h2>Step 2: Review Changes</h2>
                
                <div id="statsSection"></div>
                
                <div id="changesSection" style="margin-top: 30px;">
                    <h3>Proposed Changes</h3>
                    <div id="changesList" class="changes-list"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-warning" id="dryRunBtn">Dry Run</button>
                    <button class="btn btn-success" id="applyBtn">Apply Changes</button>
                    <button class="btn btn-secondary" id="backBtn">Back</button>
                </div>
            </div>

            <!-- Step 3: Processing -->
            <div class="section" id="step3">
                <h2>Processing...</h2>
                <div class="spinner"></div>
                <div class="loading-text">Tidying your library, please wait...</div>
            </div>

            <!-- Step 4: Results -->
            <div class="section" id="step4">
                <h2>Results</h2>
                <div id="resultsSection"></div>
                <div class="button-group">
                    <button class="btn btn-primary" id="newScanBtn">Scan Again</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let plannedMoves = [];

        // Step navigation
        function showStep(stepNum) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');
        }

        // Validate path
        document.getElementById('libraryPath').addEventListener('blur', async function() {
            const path = this.value.trim();
            if (!path) return;

            const validation = document.getElementById('pathValidation');
            validation.style.display = 'block';
            validation.textContent = 'Validating...';
            validation.className = 'path-validation';

            try {
                const response = await fetch('/api/validate-path', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path})
                });
                const data = await response.json();

                if (data.valid) {
                    validation.className = 'path-validation valid';
                    validation.textContent = data.is_library 
                        ? `‚úì Valid library (${data.metadata_files} books found)`
                        : '‚ö† Valid path, but no metadata.json files found';
                } else {
                    validation.className = 'path-validation invalid';
                    validation.textContent = '‚úó ' + data.error;
                }
            } catch (error) {
                validation.className = 'path-validation invalid';
                validation.textContent = '‚úó Error validating path';
            }
        });

        // Scan library
        document.getElementById('scanBtn').addEventListener('click', async function() {
            const path = document.getElementById('libraryPath').value.trim();
            const configPath = document.getElementById('configPath').value.trim();

            if (!path) {
                alert('Please enter a library path');
                return;
            }

            this.disabled = true;
            this.textContent = 'Scanning...';

            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        path,
                        config_path: configPath || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Scan failed');
                }

                const data = await response.json();
                currentJobId = data.job_id;
                plannedMoves = data.planned_moves;

                displayStats(data.stats);
                displayChanges(data.planned_moves, data.total_planned);
                showStep(2);

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                this.disabled = false;
                this.textContent = 'Scan Library';
            }
        });

        // Display statistics
        function displayStats(stats) {
            const html = `
                <div class="alert alert-info">
                    <strong>Library scanned successfully!</strong>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${stats.books}</h3>
                        <p>Total Books</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.authors}</h3>
                        <p>Authors</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.series}</h3>
                        <p>Series</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.formatted_duration}</h3>
                        <p>Total Duration</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.formatted_size}</h3>
                        <p>Library Size</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.narrators}</h3>
                        <p>Narrators</p>
                    </div>
                </div>
            `;
            document.getElementById('statsSection').innerHTML = html;
        }

        // Display changes
        function displayChanges(moves, total) {
            if (moves.length === 0) {
                document.getElementById('changesSection').innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚ú® Great news!</strong> Your library is already tidy! No changes needed.
                    </div>
                `;
                document.getElementById('dryRunBtn').style.display = 'none';
                document.getElementById('applyBtn').style.display = 'none';
                return;
            }

            const displayCount = Math.min(moves.length, 100);
            const html = moves.slice(0, 100).map(book => `
                <div class="book-item">
                    <h4>${book.title}</h4>
                    ${book.folder_changed ? `
                        <div class="change-item">
                            <div class="old-path">üìÅ ${book.old_dir}</div>
                            <div class="new-path">üìÅ ${book.target_dir}</div>
                        </div>
                    ` : ''}
                    ${book.file_changes.filter(f => f.changed).map(file => `
                        <div class="change-item">
                            <div class="old-path">üìÑ ${file.old}</div>
                            <div class="new-path">üìÑ ${file.new}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            document.getElementById('changesList').innerHTML = html;
            
            if (total > 100) {
                document.getElementById('changesSection').innerHTML += `
                    <div class="alert alert-warning" style="margin-top: 15px;">
                        Showing first 100 of ${total} books with changes
                    </div>
                `;
            }
        }

        // Apply changes
        async function applyChanges(dryRun = false) {
            if (!currentJobId) return;

            showStep(3);

            try {
                const response = await fetch('/api/apply', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_id: currentJobId,
                        dry_run: dryRun
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Apply failed');
                }

                // Poll for status
                await pollStatus(dryRun);

            } catch (error) {
                showStep(4);
                document.getElementById('resultsSection').innerHTML = `
                    <div class="alert alert-error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Poll job status
        async function pollStatus(dryRun) {
            const maxAttempts = 300; // 5 minutes
            let attempts = 0;

            const poll = async () => {
                if (attempts++ > maxAttempts) {
                    throw new Error('Operation timeout');
                }

                const response = await fetch(`/api/status/${currentJobId}`);
                const data = await response.json();

                if (data.status === 'completed') {
                    displayResults(data.results, data.collision_list, dryRun);
                } else if (data.status === 'error') {
                    throw new Error(data.error || 'Unknown error');
                } else {
                    setTimeout(poll, 1000);
                }
            };

            await poll();
        }

        // Display results
        function displayResults(results, collisions, dryRun) {
            let html = `
                <div class="alert alert-success">
                    <strong>${dryRun ? 'Dry run completed!' : 'Library tidied successfully!'}</strong>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${results.applied}</h3>
                        <p>${dryRun ? 'Would Process' : 'Processed'}</p>
                    </div>
                    ${results.errors > 0 ? `
                        <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                            <h3>${results.errors}</h3>
                            <p>Errors</p>
                        </div>
                    ` : ''}
                    ${results.collisions > 0 ? `
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <h3>${results.collisions}</h3>
                            <p>Collisions</p>
                        </div>
                    ` : ''}
                </div>
            `;

            if (collisions && collisions.length > 0) {
                html += `
                    <div class="collision-list">
                        <h4>‚ö†Ô∏è File Collisions (${collisions.length})</h4>
                        <p>These files already exist at the target location:</p>
                        <ul>
                            ${collisions.map(f => `<li>‚Ä¢ ${f}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            document.getElementById('resultsSection').innerHTML = html;
            showStep(4);
        }

        // Event listeners
        document.getElementById('dryRunBtn').addEventListener('click', () => applyChanges(true));
        document.getElementById('applyBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to apply these changes?')) {
                applyChanges(false);
            }
        });
        document.getElementById('backBtn').addEventListener('click', () => showStep(1));
        document.getElementById('newScanBtn').addEventListener('click', () => {
            currentJobId = null;
            plannedMoves = [];
            showStep(1);
        });

        // ============================================
        // PWA Installation & Service Worker
        // ============================================
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.className = 'btn btn-primary install-btn';
        installButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        installButton.innerHTML = 'üì± Install App';
        document.body.appendChild(installButton);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('‚úÖ PWA installed');
            }
            
            deferredPrompt = null;
            installButton.style.display = 'none';
        });

        // Hide install button if already installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA was installed');
            installButton.style.display = 'none';
        });

        // Check if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
            console.log('‚úÖ Running as PWA');
            installButton.style.display = 'none';
        }
    </script>
</body>
</html>
